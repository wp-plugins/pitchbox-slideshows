<?php
if (!defined('ABSPATH')) exit;
class PitchboxSlideShowsAdmin {		private $_slides;	private $_slideshow_themes = array('beige','black','blood','league','moon','night',											'serif','simple','sky','solarized','white');	private $_slideshow_settings;	private $_transitions = array('none','fade','slide','convex','concave','zoom');	private $_has_premium;
		public function __construct() {		add_action( 'init',					array('PitchboxSlideShowsAdmin','init') );		add_action( 'plugins_loaded',					array($this, 'check_premium') );		add_action( 'add_meta_boxes_pitchbox_slideshows', 					array($this, 'get_post_info' ), -10 );		add_action( 'add_meta_boxes_pitchbox_slideshows', 					array($this, 'add_builder_mb') );		add_action( 'add_meta_boxes_pitchbox_slideshows', 					array($this, 'add_conf_mb') );		add_action ( 'add_meta_boxes_pitchbox_slideshows', 					array ($this, 'add_slides_management_mb'));		add_action( 'save_post', 					array($this, 'get_post_info_save' ), -10, 2 );		add_action( 'save_post', 					array($this, 'save_builder_data'), 10, 2 );		add_action( 'save_post', 					array($this, 'save_new_slide_data'), 10, 2 );		add_action( 'save_post', 					array($this, 'save_data'), 10, 2 );		add_action( 'save_post', 					array($this, 'save_data_on_delete'), 10, 2 );		add_action( 'admin_enqueue_scripts', 					array($this, 'add_admin_style_and_scripts'), 10, 1 );	}	
	public static function init() {
    	register_post_type( 'pitchbox_slideshows',
			array(
				'labels' => array(
					'name' => __( 'SlideShows', 'pitchbox-slideshows' ),
					'singular_name' => __( 'SlideShow', 'pitchbox-slideshows' ),					'add_new_item' => _x('Add New SlideShow', 'new SlideShow post object', 'pitchbox-slideshows'),					'edit_item' => __('Edit SlideShow', 'pitchbox-slideshows'),					'new_item' => __('New SlideShow', 'pitchbox-slideshows'),					'view_item' => __('View SlideShow', 'pitchbox-slideshows'),
					'search_items' => __('Search for SlideShows', 'pitchbox-slideshows'),
					'not_found' => __('No SlideShow found', 'pitchbox-slideshows'),
					'not_found_in_trash' => __('No SlideShow found in Trash', 'pitchbox-slideshows'),					'parent_item_colon' => __('Parent SlideShow', 'pitchbox-slideshows')
					),
				'public' => true,
				'supports' => ('title'),
				'has_archive' => true,
				'rewrite' => array('slug' => _x('slideshows','Slug used in permalinks')),
				'menu_icon' => plugins_url( 'images/icon.png', __FILE__ )
			)
		);
	}		public function check_premium() {		$this->_has_premium = class_exists( 'PitchboxSlideShowsProAdmin' );		if ( !$this->_has_premium ) {			add_action( 'admin_menu' , 						array($this, 'add_premium_link') );			add_action( 'admin_enqueue_scripts', 						array($this, 'add_inline_style') );			add_action( 'admin_footer', 						array($this, 'add_inline_script') );			add_action( 'add_meta_boxes_pitchbox_slideshows', 						array($this, 'add_premium_mb') );		}	}		public function get_post_info($post) {		if ( !isset($this->_slides) ) {			$this->_slides = maybe_unserialize(				get_post_meta( $post->ID, '_pitchbox_slides', true )				);		}		if ( !isset($this->_slideshow_settings) ) {			$this->_slideshow_settings = maybe_unserialize(				get_post_meta( $post->ID, '_pitchbox_slideshow_settings', true )				);		}		do_action(	'pitchbox_slideshows_post_info', 					$this->_slides, 					$this->_slideshow_settings );	}	public function get_post_info_save($post_id, $post) {		if ( 'pitchbox_slideshows' !== $post->post_type )		{ return; }		else {			if ( !isset($this->_slides) ) {				$this->_slides = maybe_unserialize(					get_post_meta( $post->ID, '_pitchbox_slides', true )					);			}			if ( !isset($this->_slideshow_settings) ) {				$this->_slideshow_settings = maybe_unserialize(					get_post_meta( $post->ID, '_pitchbox_slideshow_settings', true )					);			}		}	}

	public function add_builder_mb( ) {
		add_meta_box(
			($this->_slides) ? 'pitchbox_slideshows_builder_2' : 'pitchbox_slideshows_builder',
			__( 'Build your SlideShow :', 'pitchbox-slideshows' ),
			array($this, 'builder_mb_render'),
			'pitchbox_slideshows',
			($this->_slides) ? 'side' : 'normal',			'default'
		);
	}		public function add_conf_mb() {		if ($this->_slides) {			add_meta_box(				'pitchbox_slideshows_conf',				__('SlideShow Settings :', 'pitchbox-slideshows'),				array($this, 'conf_mb_render'),				'pitchbox_slideshows',				'side',				'default'			);		}	}		public function add_premium_mb() {		if ( $this->_slides ) {			add_meta_box(				'premium-addon',				__('Even more Features ?', 'pitchbox-slideshows'),				array($this, 'premium_mb_renderer'),				'pitchbox_slideshows',				'side',				'default'			);		}	}		public function add_slides_management_mb( $post ) {		if ($this->_slides) {			foreach ($this->_slides as $key => $slide) {				$j = $key + 1;				add_meta_box(					"{$key}_pitchbox_slide_management_box",					__("Slide {$j} :", 'pitchbox-slideshows'),					array( $this, 'slide_management_mb_render'),					'pitchbox_slideshows',					'normal',					'default',					array('number' => $key, 						  'content' => empty($slide['content']) ? '' : $slide['content'], 						  'transition' => empty($slide['transition']) ? '' : $slide['transition'],						  'use_slideshow_transition' => empty($slide['use_slideshow_transition']) ? 								'' : $slide['use_slideshow_transition']						)				);			}		}	}		public function builder_mb_render( $post ) {		if ( !$this->_slides ) {			wp_nonce_field( 'pitchbox_slidesbuilder', 'pitchbox_slidesbuilder_nonce' );			?>			<div class="one_half align-center">			<p><label for="pitchbox_create_pitch_slides_number">			<?php _e( 'Number of Slides for your Presentation :', 'pitchbox-slideshows' ); ?>			</label></p>			<p>			<input type="text" id="pitchbox_create_pitch_slides_number" name="pitchbox_create_pitch_slides_number" value="<?php echo esc_attr( count($this->_slides) ); ?>" size="10" />			</p>			</div>			<div class="one_half_last align-center">			<?php			submit_button( __('Create Slideshow', 'pitchbox-slideshows'), 'primary', 'pitchbox_create_pitch_submit' );			?>			</div><div class="clear"></div> <?php		}		else {			wp_nonce_field( 'pitchbox_slidesbuilder', 'pitchbox_slidesbuilder_nonce' );			?> 				<p>Add new Slide after :				<select name="pitchbox_add_slide">				<?php foreach ( $this->_slides as $key => $slide ) {					printf('<option value="%s">Slide %s</option>',						 esc_attr($key + 1),						 esc_attr($key + 1)						 );				} ?>				</select>				</p>				<?php				submit_button( __('Add slide', 'pitchbox-slideshows'), 'primary', 'pitchbox_add_slide_submit' );		}	}		public function conf_mb_render() {		?>		<p>SlideShow Theme :		<select name="pitchbox_slideshow_theme">				<?php 				foreach ($this->_slideshow_themes as $theme) {					printf('<option value="%s" %s>%s</option>',						 esc_attr($theme),						 selected(							$this->_slideshow_settings['theme'],							$theme,							false							),						 esc_attr(ucfirst($theme))						 );				} ?>		</select>		</p>		<p>SlideShow Transition :		<select name="pitchbox_slideshow_transition">			<?php			foreach ($this->_transitions as $transition) {				printf('<option value="%s" %s>%s</option>',						 esc_attr($transition),						 selected(							$this->_slideshow_settings['transition'],							$transition,							false							),						 esc_attr(ucfirst($transition)) );			}			?>		</select>		</p>		<p>Auto-Sliding :		<select id="pitchbox_slideshow_autoslide" name="pitchbox_slideshow_autoslide">		<?php printf(			'<option value="yes" %s>Yes</option><option value="no" %s>No</option>',			selected( $this->_slideshow_settings['autoslide'], 'yes', false),			selected( $this->_slideshow_settings['autoslide'], 'no', false) );		?>		</select></p>		<?php printf(			'<p id="pitchbox_slideshow_autoslideduration" %s>Auto-Slide Duration (in seconds) : <input type="text" size="2" name="pitchbox_slideshow_autoslideduration" value="%s" %s /></p>',			( !isset($this->_slideshow_settings['autoslideduration']) ) ? 'style="display:none;"' : '',			( !isset($this->_slideshow_settings['autoslideduration']) ) ? '' : 			$this->_slideshow_settings['autoslideduration'],			( !isset($this->_slideshow_settings['autoslideduration']) ) ? 'disabled="disabled"' :			''			);		do_action('pitchbox_slideshows_settings');	}			public function premium_mb_renderer( $post ) {		?>		<p class="pb-title">The Pitchbox Slideshows Pro Add-on gives your Slideshows even more features :</p>		<ul>		<li><div class="pb-dashicon-yes"></div>Customize your Slideshows with your website's colors with the Colorization tool</li>		<li><div class="pb-dashicon-yes"></div>Embed your Slideshows directly in posts and pages</li>		<li><div class="pb-dashicon-yes"></div>Customize Slides with images, videos or iframes backgrounds</li>		<li><div class="pb-dashicon-yes"></div>Add your Company's or School's logo on your Slideshow</li>		<li><div class="pb-dashicon-yes"></div>Better responsive aspect, on vertical viewport devices like smartphones</li>		</ul>		<div class="pb-title"><a href="https://www.pitchbox.io/slideshows-pro-add-on/" target="_blank" class="button-primary button-large pb-title">Give it a try !</a></div>		<?php	}		public function slide_management_mb_render( $post, $metabox ) {		wp_nonce_field( "pitchbox_slides_management_boxes", "pitchbox_slides_management_boxes_nonce" );		?>		<div class="one_third">		<p><a class="button thickbox pitchbox-dash-settings-a" href="#TB_inline?width=640&inlineId=slide<?php echo esc_attr($metabox['args']['number']) ?>Settings" title="Slide Settings"><span class="pitchbox-dash-settings-span"></span>Slide Settings</a></p>		<div id="slide<?php echo esc_attr($metabox['args']['number']) ?>Settings" style="display:none">		<div id="slideSettingsContent<?php echo esc_attr($metabox['args']['number']) ?>">		<h3>Slide Transition :</h3>		<p>This setting will override the Slideshow general transition setting, for this individual slide only.</p>		<div class="one_half"><select name="<?php echo esc_attr("pitchbox_slideeditor[{$metabox['args']['number']}][transition]") ;?>" class="tb_select" <?php disabled( $metabox['args']['use_slideshow_transition'], 'yes', true ); ?>>		<?php			foreach ($this->_transitions as $transition) {			printf('<option value="%s" %s>%s</option>',					esc_attr($transition),					selected($metabox['args']['transition'], $transition, false),					esc_attr(ucfirst($transition)) );			}		?></select></div><div class="one_half_last"><input type="checkbox" value="yes" name="<?php echo esc_attr("pitchbox_slideeditor[{$metabox['args']['number']}][use_slideshow_transition]"); ?>" <?php checked($metabox['args']['use_slideshow_transition'], 'yes', true ); ?> />Use default Slideshow Transition</div><div class="clear"></div>		<?php do_action( 'pitchbox_slideshows_slide_settings', $metabox['args']['number'] );		if ( !$this->_has_premium ) { ?>		<p><a href="https://www.pitchbox.io/slideshows-pro-add-on/" target="_blank">With the Premium Add-on</a> you can customize your Slides even further, and set for each Slide an image, video or Iframe background !</p>		<?php } ?>		</div>		</div>		</div>		<div class="one_third">		<p></p>		</div>		<div class="one_third"><p>		<?php printf( '<button type="submit" class="pitchboxdelete" name="pitchbox_delete_slide[%s]" value="%s">Move Slide %s to Trash</button>',					 esc_attr($metabox['args']['number']),					 esc_attr($metabox['args']['number']),					 htmlspecialchars_decode($metabox['args']['number'] + 1) );		?>		</p></div><div class="clear"></div> <?php		wp_editor( 				empty($metabox['args']['content']) ? '' : 			htmlspecialchars_decode($metabox['args']['content']),			"slideeditor{$metabox['args']['number']}", 			$settings = array(				'textarea_name'=> "pitchbox_slideeditor[{$metabox['args']['number']}][content]",				'textarea_rows'=> 10 ) );	}		public function save_builder_data($post_id, $post) {		if ( 'pitchbox_slideshows' !== $post->post_type )		{ return; }		else {				if ( isset( $_POST['pitchbox_create_pitch_slides_number'] ) )			{				if ( !$this->check_authorization( 						'pitchbox_slidesbuilder_nonce', 						'pitchbox_slidesbuilder', 						$post_id ) )					return $post_id;								$slidesnumber = intval( sanitize_text_field( $_POST['pitchbox_create_pitch_slides_number'] ) );				if ( !$slidesnumber )				{ 					return; }				else {					$slides = array();					$slideshow_settings = array();					for ($i = 0; $i < $slidesnumber ; $i++) {						$slides[$i]['content'] = '';						$slides[$i]['use_slideshow_transition'] = 'yes';						$slides[$i]['transition'] = 'none';					}					$slideshow_settings['theme'] = 'beige';					$slideshow_settings['transition'] = 'slide';					$slideshow_settings['autoslide'] = 'no';										$slides = apply_filters(										'pitchbox_slideshows_save_slides',										$slides,										'builder');										$slideshow_settings = apply_filters(										'pitchbox_slideshows_save_settings', 										$slideshow_settings, 										'builder');										update_post_meta( $post_id, '_pitchbox_slides', $slides );					update_post_meta($post_id, '_pitchbox_slideshow_settings', $slideshow_settings );				}			}		}	}		public function save_new_slide_data($post_id, $post) {		if ( 'pitchbox_slideshows' !== $post->post_type )		{ return; }		else {			if ( isset ( $_POST['pitchbox_add_slide_submit'] ) && 				isset ($_POST['pitchbox_add_slide']) ) 			{				if ( !$this->check_authorization( 						'pitchbox_slidesbuilder_nonce', 						'pitchbox_slidesbuilder', 						$post_id ) )					return $post_id;								$add_slide_after = intval($_POST['pitchbox_add_slide']);				if (is_int($add_slide_after)) {					$slides = array();					$slideshow_settings = array();					foreach ($_POST["pitchbox_slideeditor"] as $key => $slide) {						if ($key < $add_slide_after ) {							$slides[$key]['content'] = wp_kses_post(								htmlspecialchars($slide['content'])							);							$slides[$key]['transition'] = isset($slide['transition']) ? 								sanitize_text_field( $slide['transition'] ) : 'none';							$slides[$key]['use_slideshow_transition'] = isset($slide['use_slideshow_transition']) ?								'yes' : 'no';						}						else if ($key === $add_slide_after) {							$slides[$key]['content'] = '';							$slides[$key]['transition'] = 'none';							$slides[$key]['use_slideshow_transition'] = 'yes';							$slides[$key + 1]['content'] = wp_kses_post(								htmlspecialchars($slide['content'])							);							$slides[$key + 1]['transition'] = isset($slide['transition']) ?								sanitize_text_field( $slide['transition'] ) : 'none';							$slides[$key + 1]['use_slideshow_transition'] = isset($slide['use_slideshow_transition']) ?								'yes' : 'no';						}						else {							$slides[($key + 1)]['content'] = wp_kses_post(								htmlspecialchars($slide['content'])							);							$slides[$key + 1]['transition'] = isset($slide['transition']) ?								sanitize_text_field( $slide['transition'] ) : 'none';							$slides[$key + 1]['use_slideshow_transition'] = isset($slide['use_slideshow_transition']) ?								'yes' : 'no';						}					}					if ( $add_slide_after === count($_POST["pitchbox_slideeditor"]) ) {							$slides[$add_slide_after]['content'] = '';							$slides[$add_slide_after]['transition'] = 'none';							$slides[$add_slide_after]['use_slideshow_transition'] = 'yes';					}										if (isset($_POST['pitchbox_slideshow_theme'])) {						$slideshow_settings['theme'] = sanitize_text_field(							$_POST['pitchbox_slideshow_theme']						);					}					if (isset($_POST['pitchbox_slideshow_transition'])) {						$slideshow_settings['transition'] = sanitize_text_field(							$_POST['pitchbox_slideshow_transition']						);					}					if (isset($_POST['pitchbox_slideshow_autoslide'])) {						$slideshow_settings['autoslide'] = sanitize_text_field(							$_POST['pitchbox_slideshow_autoslide']						);					}					if (isset($_POST['pitchbox_slideshow_autoslideduration'])) {						if ( $slideshow_settings['autoslide'] === 'yes' ) {						$autoslideduration = intval( sanitize_text_field( $_POST['pitchbox_slideshow_autoslideduration'] ) );							if ( $autoslideduration !== 0 )							$slideshow_settings['autoslideduration'] = $autoslideduration;							else 							$slideshow_settings['autoslideduration'] = 0;						}					}										$slides = apply_filters(									'pitchbox_slideshows_save_slides',									$slides,									'newslide',									$add_slide_after);										$slideshow_settings = apply_filters(										'pitchbox_slideshows_save_settings', 										$slideshow_settings, 										'save');					update_post_meta($post_id, '_pitchbox_slides', $slides );					update_post_meta($post_id, '_pitchbox_slideshow_settings', $slideshow_settings );				}			}		}	}	
	public function save_data( $post_id, $post ) {
		if ( 'pitchbox_slideshows' !== $post->post_type )
		{ return; }
		else {
			if ( isset( $_POST["pitchbox_slideeditor"] ) &&				 !isset( $_POST['pitchbox_add_slide_submit'] ) ) 			{				if ( !$this->check_authorization( 						'pitchbox_slides_management_boxes_nonce', 						'pitchbox_slides_management_boxes', 						$post_id ) )					return $post_id;
								$slides = array();				$slideshow_settings = array();
				foreach ( $_POST["pitchbox_slideeditor"] as $key => $slide ) {
					$slides[$key]['content'] = wp_kses_post(						htmlspecialchars($slide['content']) 					);					$slides[$key]['transition'] = isset($slide['transition']) ? 						sanitize_text_field( $slide['transition'] ) : 'none';					$slides[$key]['use_slideshow_transition'] = isset($slide['use_slideshow_transition']) ?						'yes' : 'no';					
				}				if (isset($_POST['pitchbox_slideshow_theme'])) {					$slideshow_settings['theme'] = sanitize_text_field(											$_POST['pitchbox_slideshow_theme']											);				}				if (isset($_POST['pitchbox_slideshow_transition'])) {					$slideshow_settings['transition'] = sanitize_text_field(						$_POST['pitchbox_slideshow_transition']					);				}				if (isset($_POST['pitchbox_slideshow_autoslide'])) {					$slideshow_settings['autoslide'] = sanitize_text_field(							$_POST['pitchbox_slideshow_autoslide']						);				}				if (isset($_POST['pitchbox_slideshow_autoslideduration'])) {					if ( $slideshow_settings['autoslide'] === 'yes' ) {						$autoslideduration = intval( sanitize_text_field( $_POST['pitchbox_slideshow_autoslideduration'] ) );							if ( $autoslideduration !== 0 )							$slideshow_settings['autoslideduration'] = $autoslideduration;							else 							$slideshow_settings['autoslideduration'] = 0;						}				}				$slides = apply_filters(								'pitchbox_slideshows_save_slides',								$slides,								'save');								$slideshow_settings = apply_filters(									'pitchbox_slideshows_save_settings', 									$slideshow_settings, 									'save');				
				update_post_meta($post_id, '_pitchbox_slides', $slides );				update_post_meta($post_id, '_pitchbox_slideshow_settings', $slideshow_settings );
			}		}	}		public function save_data_on_delete( $post_id, $post ) {		if ( 'pitchbox_slideshows' !== $post->post_type )		{ return; }		else {			if ( isset( $_POST["pitchbox_delete_slide"] ) ) 			{				if ( !$this->check_authorization( 						'pitchbox_slides_management_boxes_nonce', 						'pitchbox_slides_management_boxes', 						$post_id ) )					return $post_id;								$slide_to_delete = intval( array_shift($_POST['pitchbox_delete_slide']) );				if (is_int($slide_to_delete)) {					$slides = array();					$slideshow_settings = array();					foreach ( $_POST["pitchbox_slideeditor"] as $key => $slide )					{						if ($key < $slide_to_delete) {							$slides[$key]['content'] = wp_kses_post(								htmlspecialchars($slide['content'])							);							$slides[$key]['transition'] = isset($slide['transition']) ?								sanitize_text_field( $slide['transition'] ) : 'none';							$slides[$key]['use_slideshow_transition'] = isset($slide['use_slideshow_transition']) ?								'yes' : 'no';						}						else if ($key === $slide_to_delete) {							continue;						}						else {							$slides[$key - 1]['content'] = wp_kses_post(							htmlspecialchars($slide['content'])							);							$slides[$key - 1]['transition'] = isset($slide['transition']) ?								sanitize_text_field( $slide['transition'] ) : 'none';							$slides[$key - 1]['use_slideshow_transition'] = isset($slide['use_slideshow_transition']) ?								'yes' : 'no';						}					}										if (isset($_POST['pitchbox_slideshow_theme'])) {						$slideshow_settings['theme'] = sanitize_text_field(								$_POST['pitchbox_slideshow_theme']							);					}					if (isset($_POST['pitchbox_slideshow_transition'])) {						$slideshow_settings['transition'] = sanitize_text_field(							$_POST['pitchbox_slideshow_transition']						);					}					if (isset($_POST['pitchbox_slideshow_autoslide'])) {						$slideshow_settings['autoslide'] = sanitize_text_field(								$_POST['pitchbox_slideshow_autoslide']							);					}					if (isset($_POST['pitchbox_slideshow_autoslideduration'])) {						if ( $slideshow_settings['autoslide'] === 'yes' ) {						$autoslideduration = intval( sanitize_text_field( $_POST['pitchbox_slideshow_autoslideduration'] ) );							if ( $autoslideduration !== 0 )							$slideshow_settings['autoslideduration'] = $autoslideduration;							else 							$slideshow_settings['autoslideduration'] = 0;						}					}										$slides = apply_filters(									'pitchbox_slideshows_save_slides',									$slides,									'saveondelete',									$slide_to_delete);										$slideshow_settings = apply_filters(										'pitchbox_slideshows_save_settings', 										$slideshow_settings, 										'save');										update_post_meta($post_id, '_pitchbox_slides', $slides );					update_post_meta($post_id, '_pitchbox_slideshow_settings', $slideshow_settings );				}			}		}	}		public function add_admin_style_and_scripts( $hook ) {		global $post;		if (isset($post->post_type)) {        if ( 'pitchbox_slideshows' === $post->post_type ) {			add_thickbox();            wp_enqueue_style(  'pitchbox-slideshows-admin-css', 								plugins_url( 'css/admin.css', 											__FILE__ ),								array(),								PITCHBOX_SLIDESHOWS_PLUGIN_VERSION							);			wp_enqueue_script( 'pitchbox-slideshows-admin-js',								plugins_url( 'js/admin.js', 											__FILE__ ),								array('jquery', 'thickbox'),								PITCHBOX_SLIDESHOWS_PLUGIN_VERSION,								true							);			}		}	}		public function add_premium_link() {			global $submenu;			$submenu['edit.php?post_type=pitchbox_slideshows'][] = array( '<span class="pb-premium" id="pb-premium-link">Upgrade to Pro</span>', 'edit_posts' , 'https://www.pitchbox.io/slideshows-pro-add-on/' );	}		public function add_inline_style() {		global $wp_version;		if ( version_compare( $wp_version, '3.6', '>=' ) ) {            $premium_css = "                .pb-premium{					color: #00FF00;                }				.pb-premium:hover{					color: #00E600;                }";			wp_add_inline_style( 'wp-admin', $premium_css );        }	}		public function add_inline_script() {		?>		<script type="text/javascript">		jQuery(document).ready(function($) {			$('#pb-premium-link').parent().attr('target','_blank');		});		</script>		<?php	}		public function check_authorization($nonce, $origin, $post_id) {		if ( ! isset( $_POST[$nonce] ) )			return false;			if ( ! wp_verify_nonce( $_POST[$nonce], $origin ) )			return false;					if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) 			return false;				if ( ! current_user_can( 'edit_post', $post_id ) )			return false;				return true;	}
  
}

?>